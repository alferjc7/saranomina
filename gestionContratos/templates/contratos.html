{% extends "base.html" %}

{% block title %}Contratos{% endblock %}
{% block content %}
<div class="header-entidades">
    <h2 class="titulo-entidades">Contratos</h2>
    <div class="acciones-entidades">
        <form method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" name="accion" value="exportar_excel" class="btn btn-success">
                üì• Exportar
            </button>
        </form>
    </div>
</div>

<form method="get">
    <div class="card">
        <div class="form-grid-2">
            <div>
                <div class="form-group2">
                    <input type="text" name="identificacion" placeholder="Buscar por identificaci√≥n"
                        value="{{ request.GET.identificacion }}">
                </div>
            </div>
            <div>
                <div class="form-group2">
                    <input type="text" name="contrato" placeholder="Buscar por contrato"
                        value="{{ request.GET.contrato }}">
                </div>
            </div>
            <div>
                <div class="form-group2">
                    <button type="submit">üîçBuscar</button>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Identificacion</th>
                <th>Codigo contrato</th>
                <th>Fecha ingreso</th>
                <th>Fecha fin</th>
                <th>Tipo contrato</th>
                <th>Periodo Vac</th>
                <th>Tipo cotizante</th>
                <th>Subtipo cotizante</th>
                <th>Codigo interno</th>
                <th>Tipo nomina</th>
                <th>Motivo retiro</th>
                <th>Fecha retiro</th>
                <th>Asignar Salario</th>
                <th>Asignar Banco</th>
                <th>Asignar Entidad</th>
                <th>Asignar Deducible</th>
                <th>Editar</th>
            </tr>
        </thead>
        <tbody>
            {% for b in registros %}
            <tr>
                <td>{{ b.identificacion }}</td>
                <td>{{ b.cod_contrato }}</td>
                <td>{{ b.fecha_ingreso|date:"d/m/Y" }}</td>
                <td>{{ b.fecha_fin|date:"d/m/Y"|default:"" }}</td>
                <td>{{ b.tipo_contrato }}</td>
                <td>{{ b.periodo_vac}}</td>
                <td>{{ b.tipo_cotizante }}</td>
                <td>{{ b.subtipo_cotizante }}</td>
                <td>{{ b.codigo_interno }}</td>
                <td>{{ b.tipo_nomina }}</td>
                <td>{{ b.motivo_retiro|default_if_none:'' }}</td>
                <td>{{ b.fecha_ret|date:"d/m/Y"|default:"" }}</td>
                <td>
                    <form method="get" action="{% url 'contrato_salario' b.id %}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-primary">
                            üíµ Salarios
                        </button>
                    </form>
                </td>
                <td>
                    <form method="get" action="{% url 'contrato_banco' b.id %}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-primary">
                            üè¶ Bancos
                        </button>
                    </form>
                </td>
                <td>
                    <form method="get" action="{% url 'contrato_entidad_ss' b.id %}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-primary">
                            üõ°Ô∏è Entidades
                        </button>
                    </form>
                </td>
                <td>
                    <form method="get" action="{% url 'contrato_deducible' b.id %}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-primary">
                            üí∏ Deducibles
                        </button>
                    </form>
                </td>
                <td>
                    <button type="button" class="editar-btn" data-pk="{{ b.pk }}" data-ide="{{ b.identificacion.id }}"
                        data-feci="{{ b.fecha_ingreso|date:'Y-m-d' }}" data-fecf="{{ b.fecha_fin|date:'Y-m-d' }}" 
                        data-tipocont ="{{ b.tipo_contrato.id }}" data-pervac="{{ b.periodo_vac }}"
                        data-cotizante ="{{ b.tipo_cotizante.id }}" data-subcotizante="{{ b.subtipo_cotizante.id }}"
                        data-codigoi ="{{ b.codigo_interno }}"  data-tiponom ="{{ b.tipo_nomina.id }}"
                        data-movret ="{{ b.motivo_retiro.id }}" data-fecret ="{{ b.fecha_ret|date:'Y-m-d' }}"
                        data-proc ="{{ b.procedimiento }}" data-porc="{{ b.porcentaje_retencion }}"
                        data-estado ="{{ b.estado }}" data-cesantias="{{ b.cesantias }}">
                        ‚úèÔ∏è Editar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2>Nuevo contrato</h2>
<form id="contrato-form" method="POST">
    {% csrf_token %}
    <div class="card">
        <div class="form-grid-2">
            <div>
                <div class="form-group2">
                    {{ form.identificacion.label_tag }} <!-- label arriba -->
                    {{ form.identificacion }}
                    {% if form.identificacion.errors %}
                    <div class="error">{{ form.identificacion.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.fecha_ingreso.label_tag }} <!-- label arriba -->
                    {{ form.fecha_ingreso }}
                    {% if form.fecha_ingreso.errors %}
                    <div class="error">{{ form.fecha_ingreso.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.fecha_fin.label_tag }} <!-- label arriba -->
                    {{ form.fecha_fin }}
                    {% if form.fecha_fin.errors %}
                    <div class="error">{{ form.fecha_fin.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.tipo_contrato.label_tag }} <!-- label arriba -->
                    {{ form.tipo_contrato }}
                    {% if form.tipo_contrato.errors %}
                    <div class="error">{{ form.tipo_contrato.errors }}</div>
                    {% endif %}
                </div>
                
                 <div class="form-group2">
                    {{ form.tipo_nomina.label_tag }} <!-- label arriba -->
                    {{ form.tipo_nomina }}
                    {% if form.tipo_nomina.errors %}
                    <div class="error">{{ form.tipo_nomina.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="form-group2">
                    {{ form.periodo_vac.label_tag }} <!-- label arriba -->
                    {{ form.periodo_vac }}
                    {% if form.periodo_vac.errors %}
                    <div class="error">{{ form.periodo_vac.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.tipo_cotizante.label_tag }} <!-- label arriba -->
                    {{ form.tipo_cotizante }}
                    {% if form.tipo_cotizante.errors %}
                    <div class="error">{{ form.tipo_cotizante.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.subtipo_cotizante.label_tag }} <!-- label arriba -->
                    {{ form.subtipo_cotizante }}
                    {% if form.subtipo_cotizante.errors %}
                    <div class="error">{{ form.subtipo_cotizante.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.codigo_interno.label_tag }} <!-- label arriba -->
                    {{ form.codigo_interno }}
                    {% if form.codigo_interno.errors %}
                    <div class="error">{{ form.codigo_interno.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group2">
                    {{ form.cesantias.label_tag }} <!-- label arriba -->
                    {{ form.cesantias }}
                    {% if form.cesantias.errors %}
                    <div class="error">{{ form.cesantias.errors }}</div>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="form-group2">
                    {{ form.procedimiento.label_tag }} <!-- label arriba -->
                    {{ form.procedimiento }}
                    {% if form.procedimiento.errors %}
                    <div class="error">{{ form.procedimiento.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.porcentaje_retencion.label_tag }} <!-- label arriba -->
                    {{ form.porcentaje_retencion }}
                    {% if form.porcentaje_retencion.errors %}
                    <div class="error">{{ form.porcentaje_retencion.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.estado.label_tag }} <!-- label arriba -->
                    {{ form.estado }}
                    {% if form.estado.errors %}
                    <div class="error">{{ form.estado.errors }}</div>
                    {% endif %}
                </div>
                <div class="form-group2">
                    {{ form.motivo_retiro.label_tag }} <!-- label arriba -->
                    {{ form.motivo_retiro }}
                    {% if form.motivo_retiro.errors %}
                    <div class="error">{{ form.motivo_retiro.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group2">
                    {{ form.fecha_ret.label_tag }} <!-- label arriba -->
                    {{ form.fecha_ret }}
                    {% if form.fecha_ret.errors %}
                    <div class="error">{{ form.fecha_ret.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <br>
    <br>
    <button type="submit" name="accion" value="guardar">Guardar</button>
</form>
{% endblock %}
{% block scripts %}
<script>
    document.querySelectorAll('.editar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            
            const pk = btn.dataset.pk;
            const ide = btn.dataset.ide;
            const feci = btn.dataset.feci;
            const fecf = btn.dataset.fecf;
            const tipocont = btn.dataset.tipocont;
            const tiponom = btn.dataset.tiponom;
            const movret = btn.dataset.movret;
            const fecret = btn.dataset.fecret;
            const pervac = btn.dataset.pervac;
            const cotizante = btn.dataset.cotizante;
            const subcotizante = btn.dataset.subcotizante;
            const codigoi = btn.dataset.codigoi;
            const proc = btn.dataset.proc;
            const porc = btn.dataset.porc;
            const estado = btn.dataset.estado;
            const cesantias = btn.dataset.cesantias;

            // Agregar un input hidden para el pk
            let form = document.getElementById('contrato-form');
            let inputPk = form.querySelector('input[name="pk"]');
            if (!inputPk) {
                inputPk = document.createElement('input');
                inputPk.type = 'hidden';
                inputPk.name = 'pk';
                form.appendChild(inputPk);
            }

            const tipoSelect = form.querySelector('[name="tipo_cotizante"]');
            tipoSelect.value = cotizante;
            tipoSelect.dispatchEvent(new Event('change'));

            setTimeout(() => {
            form.querySelector('[name="subtipo_cotizante"]').value = subcotizante;
            }, 500);

            inputPk.value = pk;
            form.querySelector('[name="identificacion"]').value = ide;
            form.querySelector('[name="fecha_ingreso"]').value = feci;
            form.querySelector('[name="fecha_fin"]').value = fecf;
            form.querySelector('[name="tipo_contrato"]').value = tipocont;
            form.querySelector('[name="tipo_nomina"]').value = tiponom;
            form.querySelector('[name="motivo_retiro"]').value = movret;
            form.querySelector('[name="fecha_ret"]').value = fecret;
            form.querySelector('[name="periodo_vac"]').value = pervac;
            form.querySelector('[name="tipo_cotizante"]').value = cotizante;
            form.querySelector('[name="subtipo_cotizante"]').value = subcotizante;
            form.querySelector('[name="codigo_interno"]').value = codigoi;
            form.querySelector('[name="procedimiento"]').value = proc;
            form.querySelector('[name="porcentaje_retencion"]').value = porc;
            form.querySelector('[name="estado"]').value = estado;
            form.querySelector('[name="cesantias"]').value = cesantias;

            
        });
    });
</script>
<script>
document.getElementById('id_tipo_cotizante').addEventListener('change', function () {

    const tipoCotizanteId = this.value;
    const subtipoCotizanteSelect = document.getElementById('id_subtipo_cotizante');

    // üîπ Guardar el subtipo actualmente seleccionado (si existe)
    const subtipoSeleccionado = subtipoCotizanteSelect.value;

    // Limpiar opciones
    subtipoCotizanteSelect.innerHTML = '<option value="">---------</option>';

    if (!tipoCotizanteId) return;

    fetch(`/gestioncontratos/ajax/subtipos/?tipo_id=${tipoCotizanteId}`)
        .then(response => response.json())
        .then(subtipos => {
            subtipos.forEach(subtipo => {
                const option = document.createElement('option');
                option.value = subtipo.id;
                option.textContent = subtipo.descripcion;

                // üîπ Re-seleccionar el subtipo si coincide
                if (String(subtipo.id) === String(subtipoSeleccionado)) {
                    option.selected = true;
                }

                subtipoCotizanteSelect.appendChild(option);
            });
        });

});
</script>
{% endblock %}